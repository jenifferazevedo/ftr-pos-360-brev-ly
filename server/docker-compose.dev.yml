services:
  db:
    image: bitnami/postgresql:latest
    container_name: postgres
    restart: unless-stopped
    ports:
      - $POSTGRES_PORT:$POSTGRES_PORT
    environment:
      - POSTGRES_USER=$POSTGRES_USER
      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      - POSTGRES_DB=$POSTGRES_DB
    volumes:
      - './docker:/docker-entrypoint-initdb.d'
    networks:
      - db

  migrate:
    image: node:23.11-alpine
    depends_on:
      - db
    working_dir: /usr/src/app
    volumes:
      - .:/usr/src/app
    environment:
      - DATABASE_URL=$DATABASE_URL
    command: sh -c "npx wait-on tcp:db:5432 && npx drizzle-kit migrate"
    networks:
      - db

networks:
    db:
      driver: bridge